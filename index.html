<!DOCTYPE html>
<html>

<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.js"></script>
  <style>
    body{
      text-align:center;
      color: #FFFFFF;
      font-family: verdana;
    }
    #heading {
      font-size: 40vw;
    }
    .display{
      font-size: 5vw;
      overflow-anchor: none;
    }
    .message{
      display: flex;
      align-self: flex-end;
      justify-content: space-between;
      padding-top:10px;
      padding-bottom: 10px;
      background: whitesmoke;
    }
    .message >*{
      margin:5px;
    }
    p{
      background: lightskyblue;
      border-radius: 25%;
      padding:10px;
      margin-left: 20px;
      white-space: normal;
      overflow-anchor: auto;
    }

  </style>
  <title>Compass</title>


  

  <script type="text/javascript">

    var pubnubDemo = new PubNub({
      publishKey: 'pub-c-46b4ff32-3ba1-43e9-96e0-ad78f7c61ceb',
      subscribeKey: 'sub-c-65fd0c82-6d88-11e9-a9da-06324c5f6dce'
    });

    pubnubDemo.addListener({
      message: function (message) {
        console.log("pubDemo: " , message.message)
        console.log(message.channel)
        displayMessage(message.message, message.channel)
      }
    })

    pubnubDemo.subscribe({
      channels: ['north', 'south', 'west', 'east' ]
    });

    function publishMessage(){
    var dir = document.getElementById('chat-direction').innerText;
    var newMessage = document.getElementById('textfield').value;
    console.log("publishMessage: ", newMessage)
    pubnubDemo.publish({ message: newMessage, channel: [dir] });
    }

    function displayMessage(message, channel){
      const tag = document.createElement("p");  
      const channelDiv = document.getElementById(channel);
      tag.innerHTML = message;
      channelDiv.appendChild(tag);
    }


  </script>
  <script>
    // Get event data
    function deviceOrientationListener(event) {
      var alpha = event.alpha; //z axis rotation [0,360)
      var beta = event.beta; //x axis rotation [-180, 180]
      var gamma = event.gamma; //y axis rotation [-90, 90]
      //Check if absolute values have been sent
      if (typeof event.webkitCompassHeading !== "undefined") {
        alpha = event.webkitCompassHeading; //iOS non-standard
        var heading = alpha
      }
      else {
        alert("Your device is reporting relative alpha values, so this compass won't point north :(");
        var heading = 360 - alpha; //heading [0, 360)
      }

      // Change backgroud colour based on heading
      // Green for North and South, black otherwise
      if (heading > 315 || heading < 45) { //Allow +- 1 degree
        document.body.style.backgroundColor = "green";
        document.getElementById("north").style.display = "block"
        document.getElementById("east").style.display = "none"
        document.getElementById("west").style.display = "none"
        document.getElementById("south").style.display = "none"

        document.getElementById("chat-direction").innerHTML = "north";
      }
      else if (heading > 225 && heading < 314) { //Allow +- 1 degree
        document.body.style.backgroundColor = "red";
        document.getElementById("north").style.display = "none"
        document.getElementById("east").style.display = "block"
        document.getElementById("west").style.display = "none"
        document.getElementById("south").style.display = "none"
        document.getElementById("chat-direction").innerHTML = "east";
      }
      else if (heading > 45 && heading < 135) { //Allow +- 1 degree
        document.body.style.backgroundColor = "blue";
        document.getElementById("north").style.display = "none"
        document.getElementById("east").style.display = "none"
        document.getElementById("west").style.display = "block"
        document.getElementById("south").style.display = "none"
        document.getElementById("chat-direction").innerHTML = "west";
      }

      else if (heading > 135 && heading < 225) { //Allow +- 1 degree
        document.body.style.backgroundColor = "pink";
        document.getElementById("north").style.display = "none"
        document.getElementById("east").style.display = "none"
        document.getElementById("west").style.display = "none"
        document.getElementById("south").style.display = "block"
        document.getElementById("chat-direction").innerHTML = "south";
      }
      else { // Otherwise, use near black
        document.body.style.backgroundColor = "#161616";
        //pubnubDemo.unsubscribeAll();
      }
    }

    // Check if device can provide absolute orientation data
    if (window.DeviceOrientationAbsoluteEvent) {
      window.addEventListener("DeviceOrientationAbsoluteEvent", deviceOrientationListener);
    } // If not, check if the device sends any orientation data
    else if (window.DeviceOrientationEvent) {
      window.addEventListener("deviceorientation", deviceOrientationListener);
    } // Send an alert if the device isn't compatible
    else {
      alert("Sorry, try again on a compatible mobile device!");
    }
  </script>
</head>

<body>
  <div id="chat-direction"></div>
  <div class="display" id="north" style="display: none" ></div>
  <div class="display" id="south" style="display: none"></div>
  <div class="display" id="east" style="display: none"></div>
  <div class="display" id="west" style="display: none"></div>
      <div class="message">
        <input type="text" id="textfield"  label="Write your message">
        </input>
        <input type="submit" class="btn btn-primary" value="Send" onclick="publishMessage()"></input>
      </div>
</body>

</html>