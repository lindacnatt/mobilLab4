<!DOCTYPE html>
<html>

<head>
  <style>
    p {
      font-family: verdana;
      font-size: 400px;
      color: #FFFFFF;
    }
  </style>
  <title>Compass</title>


  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.js"></script>

  <script type="text/javascript">

    var pubnubDemo = new PubNub({
      publishKey: 'pub-c-46b4ff32-3ba1-43e9-96e0-ad78f7c61ceb',
      subscribeKey: 'sub-c-65fd0c82-6d88-11e9-a9da-06324c5f6dce'
    });

    pubnubDemo.addListener({
      message: function (message) {
        console.log(message.message)
        console.log(message.channel)
        displayMessage(message.message, message.channel)
      }
    })

    pubnubDemo.subscribe({
      channels: ['north', 'south', 'west','east' ]
    });

    function publishMessage(){
    var dir = document.getElementById('chat-direction').innerText;
    console.log(dir)
    var newMessage = document.getElementById('textfield').value;
    pubnubDemo.publish({ message: newMessage, channel: [dir] });
    }

    function displayMessage(message, channel){
      const tag = document.createElement("p");  
      console.log(channel)
      const channelDiv = document.getElementById(channel);
      tag.innerHTML = message.message;
      channelDiv.appendChild(tag);
    }


  </script>
  <script>
    // Get event data
    function deviceOrientationListener(event) {
      var alpha = event.alpha; //z axis rotation [0,360)
      var beta = event.beta; //x axis rotation [-180, 180]
      var gamma = event.gamma; //y axis rotation [-90, 90]
      //Check if absolute values have been sent
      if (typeof event.webkitCompassHeading !== "undefined") {
        alpha = event.webkitCompassHeading; //iOS non-standard
        var heading = alpha
      }
      else {
        alert("Your device is reporting relative alpha values, so this compass won't point north :(");
        var heading = 360 - alpha; //heading [0, 360)
      }

      // Change backgroud colour based on heading
      // Green for North and South, black otherwise
      if (heading > 315 || heading < 45) { //Allow +- 1 degree
        document.body.style.backgroundColor = "green";
        document.getElementById("heading").innerHTML = "N"; // North
        document.getElementById("north").style.display = "block"
        document.getElementById("east").style.display = "none"
        document.getElementById("west").style.display = "none"
        document.getElementById("south").style.display = "none"

        document.getElementById("chat-direction").innerHTML = "north";
      }
      else if (heading > 225 && heading < 314) { //Allow +- 1 degree
        document.body.style.backgroundColor = "red";
        document.getElementById("heading").innerHTML = "E"; // East
        document.getElementById("north").style.display = "none"
        document.getElementById("east").style.display = "block"
        document.getElementById("west").style.display = "none"
        document.getElementById("south").style.display = "none"
        document.getElementById("chat-direction").innerHTML = "east";
      }
      else if (heading > 45 && heading < 135) { //Allow +- 1 degree
        document.body.style.backgroundColor = "blue";
        document.getElementById("heading").innerHTML = "W"; // WEST
        document.getElementById("north").style.display = "none"
        document.getElementById("east").style.display = "none"
        document.getElementById("west").style.display = "block"
        document.getElementById("south").style.display = "none"
        document.getElementById("chat-direction").innerHTML = "west";
      }

      else if (heading > 135 && heading < 225) { //Allow +- 1 degree
        document.body.style.backgroundColor = "pink";
        document.getElementById("heading").innerHTML = "S"; // South
        document.getElementById("north").style.display = "none"
        document.getElementById("east").style.display = "none"
        document.getElementById("west").style.display = "none"
        document.getElementById("south").style.display = "block"
        document.getElementById("chat-direction").innerHTML = "pink";
      }
      else { // Otherwise, use near black
        document.body.style.backgroundColor = "#161616";
        //pubnubDemo.unsubscribeAll();
      }
    }

    // Check if device can provide absolute orientation data
    if (window.DeviceOrientationAbsoluteEvent) {
      window.addEventListener("DeviceOrientationAbsoluteEvent", deviceOrientationListener);
    } // If not, check if the device sends any orientation data
    else if (window.DeviceOrientationEvent) {
      window.addEventListener("deviceorientation", deviceOrientationListener);
    } // Send an alert if the device isn't compatible
    else {
      alert("Sorry, try again on a compatible mobile device!");
    }
  </script>
</head>

<body>
  <div id="chat-direction"></div>
  <div class="display" id="north" style="display: none" ></div>
  <div class="display" id="south" style="display: none"></div>
  <div class="display" id="east" style="display: none"></div>
  <div class="display" id="west" style="display: none"></div>
      <div class="message">
        <input type="text" id="textfield" placeholder="Write your message">
        </input>
        <input type="submit" value="Send" onclick="publishMessage()"></input>
      </div>
    <p id="heading" style="text-align:center"></p>
</body>

</html>